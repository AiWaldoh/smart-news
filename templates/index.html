<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Google News 2009 UI</title>
    <link rel="stylesheet" href="static/styles.css">
    <script src="static/scripts.js"></script>
</head>

<body>

    <div class="topicsContainer" id="topicsContainer"></div>
    <form id="addTopicForm">
        <input type="text" id="newTopic" placeholder="New Topic">
        <button type="submit">Add Topic</button>
    </form>

    <div class="container two-column-layout" id="mainContainer"></div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const topics = JSON.parse(localStorage.getItem('topics'));
            const promises = topics.map((topic) => {
                const loadingColumn = createLoadingColumn();
                document.getElementById('mainContainer').appendChild(loadingColumn);

                return fetch(`/api/getArticles?topic=${topic}`)
                    .then(response => response.json())
                    .then(data => {
                        const actualColumn = createColumn(data);
                        if (actualColumn instanceof Node) {
                            document.getElementById('mainContainer').replaceChild(actualColumn, loadingColumn);
                        } else {
                            console.error('Error: createColumn did not return a valid Node');
                            loadingColumn.remove(); // optionally remove the loading column
                        }
                    })
                    .catch(error => {
                        console.error('There was an error: ', error);
                        loadingColumn.remove();
                    });
            });
            // This function creates a temporary column with a loading animation
            function createLoadingColumn() {
                const containerDiv = document.createElement('div');
                containerDiv.className = 'container';

                const columnDiv = document.createElement('div');
                columnDiv.className = 'column';

                // Add your preferred loading animation here
                const loaderDiv = document.createElement('div');
                loaderDiv.className = 'loader';
                columnDiv.appendChild(loaderDiv);

                containerDiv.appendChild(columnDiv);
                return containerDiv;
            }
            function createAdditionalArticles(parentDiv, additionalArticles) {
                const additionalDiv = document.createElement('div');
                additionalDiv.className = 'additional-article';
                additionalArticles.forEach((article) => {
                    const aaInnerDiv = document.createElement('div');
                    aaInnerDiv.className = 'aa-inner';

                    const aTitle = document.createElement('a');
                    aTitle.href = article.link;
                    aTitle.className = 'title';
                    aTitle.innerText = article.title;

                    const spanSource = document.createElement('span');
                    spanSource.className = 'source';
                    spanSource.innerText = article.source;

                    aaInnerDiv.appendChild(aTitle);
                    aaInnerDiv.appendChild(spanSource);
                    additionalDiv.appendChild(aaInnerDiv);
                });

                parentDiv.appendChild(additionalDiv);
            }

            function createRelatedLinks(parentDiv, relatedLinks) {
                const relatedLinksDiv = document.createElement('div');
                relatedLinksDiv.className = 'related-links';

                relatedLinks.forEach((related, index) => {
                    const aRelated = document.createElement('a');
                    aRelated.href = related.link;
                    aRelated.className = 'related-source'; // Assigning a class for styling
                    aRelated.innerText = related.source; // Changed to display the source instead of the title

                    // If it's not the last element, add a space after it
                    if (index < relatedLinks.length - 1) {
                        const spaceSpan = document.createElement('span');
                        spaceSpan.innerHTML = '&nbsp;-&nbsp;'; // Adding a space
                        relatedLinksDiv.appendChild(aRelated);
                        relatedLinksDiv.appendChild(spaceSpan);
                    } else {
                        relatedLinksDiv.appendChild(aRelated);
                    }
                });

                parentDiv.appendChild(relatedLinksDiv);
            }

            const colorClasses = ['bg-color-1', 'bg-color-2', 'bg-color-3', 'bg-color-4'];
            // Initialize a counter outside the function
            let colorIndex = 0;

            //CREATE COLUMN FUNCTION
            function createColumn(data) {

                const mainContainer = document.getElementById('mainContainer');
                if (!mainContainer) return;


                const containerDiv = document.createElement('div');
                containerDiv.className = 'container';

                const columnDiv = document.createElement('div');
                columnDiv.className = 'column';

                const titleRowDiv = document.createElement('div');
                titleRowDiv.className = 'title-row';

                const titleH2 = document.createElement('h2');
                titleH2.innerText = data.topic;

                // Get the color class at the current colorIndex
                const colorClass = colorClasses[colorIndex];
                // Add the color class to the title-row h2 element
                titleH2.classList.add(colorClass);

                // Increment the colorIndex, and reset it if it's equal to the length of colorClasses
                colorIndex = (colorIndex + 1) % colorClasses.length;

                titleRowDiv.appendChild(titleH2);
                columnDiv.appendChild(titleRowDiv);

                // Loop through each article
                data.articles.forEach((article) => {
                    const topicDiv = document.createElement('div');
                    topicDiv.className = 'topic';

                    const newsItemDiv = document.createElement('div');
                    newsItemDiv.className = 'news-item';

                    // Add image
                    const img = document.createElement('img');
                    img.src = article.main_article.image_link;
                    img.alt = 'Image';
                    newsItemDiv.appendChild(img);

                    // Add content div
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'content';

                    // Add title, source, and description
                    const aTitle = document.createElement('a');
                    aTitle.href = article.main_article.link;
                    aTitle.className = 'title';
                    aTitle.innerText = article.main_article.title;

                    const spanSource = document.createElement('span');
                    spanSource.className = 'source';
                    spanSource.innerText = article.main_article.source;

                    // Create new span for date
                    const spanDate = document.createElement('span');
                    spanDate.style.color = 'black';

                    // Make the date text bold
                    spanDate.style.fontWeight = 'bold';

                    // Set the inner text for the date
                    spanDate.innerText = ' - ' + article.main_article.date;

                    // Append the date to the source span
                    spanSource.appendChild(spanDate);


                    const pDescription = document.createElement('p');
                    pDescription.className = 'description';
                    pDescription.innerText = article.main_article.description;

                    contentDiv.appendChild(aTitle);
                    contentDiv.appendChild(spanSource);
                    contentDiv.appendChild(pDescription);
                    newsItemDiv.appendChild(contentDiv);
                    topicDiv.appendChild(newsItemDiv);
                    if (article.additional_articles && article.additional_articles.length > 0) {
                        createAdditionalArticles(contentDiv, article.additional_articles);
                    }

                    // Related Links
                    if (article.related_links && article.related_links.length > 0) {
                        createRelatedLinks(contentDiv, article.related_links);
                    }

                    columnDiv.appendChild(topicDiv);
                });


                containerDiv.appendChild(columnDiv);
                mainContainer.appendChild(containerDiv);
                return containerDiv;
            }


        });
    </script>